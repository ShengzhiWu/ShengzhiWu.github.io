<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âˆž Note</title>
    <link rel="icon" href="assets/icons/infinite-note.png">
    <link rel="shortcut icon" href="assets/icons/infinite-note.png">
    <link rel="apple-touch-icon" href="assets/icons/infinite-note.png">


    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/tappy@0.3.1/dist/tappy.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
</head>
<body>
    <style>
        body {
            touch-action: none ;
            -webkit-user-select: none;
            user-select: none;
            /* display: flex;
            flex-direction: column; */
            align-items: center;
            justify-content: center;
            /* height: 100vh; */
            margin: 0;
            padding: 0;
        }

        canvas {
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            margin: 0;
            padding: 0;
            /* cursor: crosshair; */
        }

        button {
            margin-top: 10px;
            border-radius:1.5em;
            box-shadow:0.1em 0.3em 1.5em 0.0em #000000bd;
            z-index: 2;
        }
    </style>

    <canvas id="drawingCanvas" style="position: absolute; width: 100%; height: 100%; z-index: 1;"></canvas>
    <!-- <div style="position: absolute; margin: 1em;"> -->
        <button id="deleteDocumentButton" style="position: absolute; height: 3em; left: 1em; top: 1em; color: red; border: none;">Delete document</button>
        <button id="penButton" style="position: absolute; height: 3em; left: 20em; top: 1em; color: white; background-color: black; border: 3px solid white;">Pen</button>
        <button id="eraserButton" style="position: absolute; height: 3em; left: 25em; top: 1em; color: black; background-color: rgb(255, 183, 183); border: 3px solid rgba(0, 0, 0, 0);">Eraser</button>
        <button id="blackButton" style="position: absolute; width: 3em; height: 3em; left: 35em; top: 1em; background-color: black; border: 3px solid white;"></button>
        <button id="blueButton" style="position: absolute; width: 3em; height: 3em; left: 39em; top: 1em; background-color: rgb(0, 119, 255); border: 3px solid rgba(0, 0, 0, 0);"></button>
        <button id="toJSONButton" style="position: absolute; height: 3em; right: 9em; top: 1em; border: none;">To JSON</button>
        <button id="fromJSONButton" style="position: absolute; height: 3em; right: 1em; top: 1em; border: none;">From JSON</button>
    <!-- </div> -->
    <!-- <p id="console1" style="position: absolute;"></p> -->
    <!-- <p id="console2"></p> -->

    <script>

        var db;  // indexedDB database
        var document_name;
        // var objectStore;
        var request = indexedDB.open("infinite note");
        request.onsuccess = function(event)
        {
            db = event.target.result;

            const queryString = window.location.search;
            const params = new URLSearchParams(queryString);
            document_name = params.get("name");
            if(document_name==null)
            {
                var i;
                for(i=1;document_exists("Untitled note "+i);i++);
                document_name = "Untitled note "+i;
            }
            console.log(document_name);

            open_document(document_name);
        };

        function do_something_with_updating_version_of_database(f)
        {
            if(db)
                db.close();
            const request = indexedDB.open("infinite note");
            request.onsuccess = function(event)
            {
                const db = event.target.result;
                const version = db.version;
                db.close();
                const request = indexedDB.open("infinite note", version+1);
                request.onupgradeneeded = function(event)
                {
                    f(event.target.result);
                };
                request.onsuccess = function (event) {
                    const db = event.target.result;
                };
            };
            // request.onerror = function (event) {
            //     console.error(event.target.error);
            // };
        }

        function generate_json()
        {
            return JSON.stringify(
            {
                "time": new Date().getTime(),
                "strokes": strokes
            });
        }

        function document_exists_localStorage(name)
        {
            return localStorage.getItem("infinite_note/"+name)? true: false;
        }

        function document_exists_indexedDB(name)
        {
            return (db&&db.objectStoreNames.contains(name))? true: false;
        }

        function document_exists(name)
        {
            return document_exists_localStorage(name)||document_exists_indexedDB(name);
        }

        function open_document(name)
        {
            var data = localStorage.getItem("infinite_note/"+name);
            if(data)
            {
                initialize_document(JSON.parse(data));
                save_document(name);
                return;
            }

            console.log(document_exists_indexedDB(name));
            if(document_exists_indexedDB(name))
            {
                const transaction = db.transaction([name], 'readwrite');
                const objectStore = transaction.objectStore(name);

                database_item_id = 1;
                var data = {strokes: []};
                const cursorRequest = objectStore.openCursor();
                cursorRequest.onsuccess = function (event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        database_item_id ++;
                        const item = cursor.value;
                        // console.log(item);
                        switch(item.type)
                        {
                            case "metadata":
                                break;

                            case "stroke":
                                delete item.type;
                                data.strokes.push(item)
                                break;
                        }

                        cursor.continue(); // Move to the next item
                    } else {
                        // console.log(database_item_id);
                        initialize_document(data);
                    }
                };
                return;
            }
        }

        function delete_document_localStorage(name)
        {
            localStorage.removeItem('infinite_note/'+name);
        }

        function delete_document_indexedDB(name)
        {
            do_something_with_updating_version_of_database((e)=>
            {
                e.deleteObjectStore(name);
                db = e;
            });
        }

        function delete_document(name)
        {
            if(document_exists_localStorage(name))
                delete_document_localStorage(name);

            if(document_exists_indexedDB(name))
                delete_document_indexedDB(name);
        }

        var database_item_id = 1;

        function document_add_content(data, type)
        {
            data.id = database_item_id++;
            if(!document_exists_indexedDB(document_name))
            {
                do_something_with_updating_version_of_database(e=>
                {
                    db = e;
                    db.createObjectStore(document_name, { keyPath: 'id' });

                    setTimeout(() => {
                        const transaction = db.transaction([document_name], 'readwrite');
                        const objectStore = transaction.objectStore(document_name);

                        const item = {...data};
                        item.type = type;
                        const addRequest = objectStore.add(item);
                    }, 10);
                });
            }
            else
            {
                const item = {...data};
                item.type = type;
                const transaction = db.transaction([document_name], 'readwrite');
                const objectStore = transaction.objectStore(document_name);
                // console.log(objectStore);
                const addRequest = objectStore.add(item);
                addRequest.onsuccess = function (event) {
                    // console.log('JSON data added successfully');
                };
                addRequest.onerror = function (event) {
                    console.error('Error adding JSON data:', event.target.error);
                };
            }
        }

        function document_delete_stroke(stroke)
        {
            const transaction = db.transaction([document_name], 'readwrite');
            const objectStore = transaction.objectStore(document_name);
            const addRequest = objectStore.delete(stroke.id);
        }

        function save_to_database()
        {
            database_item_id = 1;
            document_add_content(
            {
                type:"metadata",
                "time": new Date().getTime()
            }, "metadata");

            strokes.forEach(e=>
            {
                document_add_content(e, "stroke");
            });
        }

        function save_document(name)
        {
            // localStorage.setItem('infinite_note/'+name, generate_json());

            if(document_exists_localStorage(name))
                delete_document_localStorage(name)

            if(!document_exists_indexedDB(name))
            {
                do_something_with_updating_version_of_database(e=>
                {
                    db = e;
                    db.createObjectStore(name, { keyPath: 'id' });
                    setTimeout(() => {
                        const transaction = db.transaction([name], 'readwrite');
                        const objectStore = transaction.objectStore(name);

                        save_to_database();
                    }, 10);
                });
            }
            else
            {
                const transaction = db.transaction([document_name], 'readwrite');
                const objectStore = transaction.objectStore(document_name);
                const request = objectStore.openCursor();
                request.onsuccess = function (event)
                {
                    const cursor = event.target.result;

                    if(cursor)
                    {
                        cursor.delete();
                        cursor.continue();
                    }
                    else  // Already deleted all items
                    {
                        save_to_database();
                    }
                };
            }

            
        }

        // if (document.documentElement.requestFullscreen) {
        // document.documentElement.requestFullscreen();
        // } else if (document.documentElement.mozRequestFullScreen) { // Firefox
        // document.documentElement.mozRequestFullScreen();
        // } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari and Opera
        // document.documentElement.webkitRequestFullscreen();
        // } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
        // document.documentElement.msRequestFullscreen();
        // }

        const canvas = document.getElementById('drawingCanvas');
        const delete_document_button = document.getElementById('deleteDocumentButton');
        const pen_button = document.getElementById('penButton');
        const eraser_button = document.getElementById('eraserButton');
        const black_button = document.getElementById('blackButton');
        const blue_button = document.getElementById('blueButton');
        const to_json_button = document.getElementById('toJSONButton');
        const from_json_button = document.getElementById('fromJSONButton');
        // const my_console1 = document.getElementById('console1');
        // const my_console2 = document.getElementById('console2');
        // my_console1.innerHTML = "Version 3";
        // my_console1.innerHTML = window.devicePixelRatio;
        canvas.width = window.innerWidth*window.devicePixelRatio;
        canvas.height = window.innerHeight*window.devicePixelRatio;
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = true;

        // window.addEventListener('load', function() {
        //     FastClick.attach(document.body);
        //     // my_console.innerHTML = "FastClick.attach";
        // }, false);

        var eraser_radius = 3*window.devicePixelRatio;

        var is_drawing = false;
        var is_moving_canvas = false;
        var tool = "pen";
        var pen_color = "black";

        canvas.width = window.innerWidth*window.devicePixelRatio;
        canvas.height = window.innerHeight*window.devicePixelRatio;
        // canvas.style.width = window.innerWidth+"px";
        // canvas.style.height = window.innerHeight+"px";

        ctx.lineWidth = 3;  // Strikes thickness
        // ctx.lineCap = 'round';
        ctx.strokeStyle = 'black';

        var canvas_offset = [0, 0];

        // var stroke_count = 0;
        var strokes = [];

        function refresh_canvas()
        {
            clear_canvas();
            strokes.forEach(stroke=>
            {
                // console.log(stroke["color"]?stroke["color"]:"black")
                ctx.strokeStyle = stroke["color"]?stroke["color"]:"black";
                const points = stroke["points"];
                // console.log(points);
                ctx.beginPath();
                ctx.moveTo(points[0][0]+canvas_offset[0], points[0][1]+canvas_offset[1]);
                for(var i=1;i<points.length;i++)
                {
                    ctx.lineTo(points[i][0]+canvas_offset[0], points[i][1]+canvas_offset[1]);
                }
                ctx.stroke();
                ctx.closePath();
            });
            ctx.strokeStyle = pen_color;
        }

        function initialize_document(data)
        {
            if(data["strokes"]==undefined)
                return;
            strokes = data["strokes"];
            refresh_canvas();
        }

        function initialize_document_with_json(data)
        {
            initialize_document(JSON.parse(data));
        }

        var last_x, last_y;

        function vector_subtract(u, v)
        {
            return [u[0]-v[0], u[1]-v[1]]
        }

        function vector_scale(k, v)
        {
            return [k*v[0], k*v[1]];
        }

        function vector_length(v)
        {
            return Math.sqrt(v[0]*v[0]+v[1]*v[1]);
        }

        function vector_dot(u, v)
        {
            return u[0]*v[0]+u[1]*v[1];
        }

        function vector_cross(u, v)
        {
            return u[0]*v[1]-u[1]*v[0];
        }

        function distance_to_line(x, y, line_start, line_end)
        {
            const p = [x, y];
            const v = vector_subtract(line_start, line_end);
            const l = vector_length(v);
            const a = vector_subtract(line_start, p);
            if(l==0.)
                return vector_length(a);
            const t = vector_dot(a, v)/(l*l);
            if(t<=0.)
                return vector_length(a);
            const b = vector_subtract(line_end, p);
            if(t>=1.)
                return vector_length(b);
            // console.log(Math.abs(vector_cross(a, b))/l);
            return Math.abs(vector_cross(a, b))/l;
        }

        function near_line(x, y, line_start, line_end, distance)
        {
            return distance_to_line(x, y, line_start, line_end)<=distance;
        }

        function near_polyline(x, y, polyline, distance)
        {
            for(var i=1;i<polyline.length;i++)
                if(near_line(x, y, polyline[i-1], polyline[i], distance))
                    return true;
            return false;
        }

        function erase(x, y)
        {
            var need_refresh = false;
            for(var i=0;i<strokes.length;i++)
            {
                if(near_polyline(x, y, strokes[i]["points"], eraser_radius))
                {
                    document_delete_stroke(strokes[i]);
                    strokes.splice(i, 1);
                    i --;
                    need_refresh = true;
                } 
            }
            return need_refresh;
        }

        function startDrawing(e) {
            console.log(e);
            // ctx.lineWidth = 6*e.pressure;

            const x = e.clientX*window.devicePixelRatio;
            const y = e.clientY*window.devicePixelRatio;
            const x_on_canvas = x-canvas_offset[0];
            const y_on_canvas = y-canvas_offset[1];

            // e.stopPropagation();
            // e.preventDefault();
            // my_console1.innerHTML = "startDrawing";
            // my_console2.innerHTML = tap_count++;
            // my_console1.innerHTML = e.pointerType;
            if(e.pointerType=='pen'||(e.pointerType=='mouse'&&e.button==0))
            {
                switch(tool)
                {
                    case "pen":
                        strokes.push(
                        {
                            "points": [[x_on_canvas, y_on_canvas]],
                            "color": pen_color
                        });
                        is_drawing = true;
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        break;

                    case "eraser":
                        is_drawing = true;
                        const need_refresh = erase(x_on_canvas, y_on_canvas);
                        if(need_refresh)
                            refresh_canvas();
                        break;
                }
                
            }
            else  // Drag canvas
            {
                last_x = x;
                last_y = y;
                is_moving_canvas = true;
            }
        }

        function drag(e) {
            const x = e.clientX*window.devicePixelRatio;
            const y = e.clientY*window.devicePixelRatio;
            const x_on_canvas = x-canvas_offset[0];
            const y_on_canvas = y-canvas_offset[1];

            // e.stopPropagation();
            // e.preventDefault();
            if (is_drawing)
            {
                // my_console1.innerHTML = "drawing";
                switch(tool)
                {
                    case "pen":
                        strokes[strokes.length-1]["points"].push([x_on_canvas, y_on_canvas]);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        break;

                    case "eraser":
                        const need_refresh = erase(x_on_canvas, y_on_canvas);
                        if(need_refresh)
                            refresh_canvas();
                        break;
                }
            }
            else if(is_moving_canvas)
            {
                canvas_offset[0] += x-last_x;
                canvas_offset[1] += y-last_y;
                refresh_canvas();
            }

            last_x = x;
            last_y = y;
        }

        function stop_drawing(e) {
            // e.stopPropagation();
            // e.preventDefault();
            // if(isDrawing)
                // my_console1.innerHTML = "stopDrawing";
            is_moving_canvas = false;
            
            if(is_drawing)
            {
                is_drawing = false;
                switch(tool)
                {
                    case "pen":
                        ctx.closePath();
                        document_add_content(strokes[strokes.length-1], "stroke");
                        break;

                    case "eraser":
                        break;
                }
            }
        }

        function clear_canvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // document.addEventListener('pointerdown', startDrawing);
        // document.addEventListener('pointermove', draw);
        // document.addEventListener('pointerup', stopDrawing);
        // document.addEventListener('pointercancel', stopDrawing);

        delete_document_button.addEventListener('click', ()=>
        {
            // console.log("button");
            strokes = [];
            refresh_canvas();
            delete_document(document_name);
        });

        to_json_button.addEventListener('click', ()=>
        {
            navigator.clipboard.writeText(generate_json())
            .then(() => {
                console.log('Text copied to clipboard');
            })
            .catch((error) => {
                console.error('Clipboard API error:', error);
            });
        });

        from_json_button.addEventListener('click', ()=>
        {
            navigator.clipboard.readText()
            .then((clipboardText) => {
                console.log('Text from clipboard:', clipboardText);
                initialize_document_with_json(clipboardText);
                save_document(document_name);
            })
            .catch((error) => {
                console.error('Clipboard API error:', error);
            });
        });

        pen_button.addEventListener('click', ()=>
        {
            tool = "pen";
            pen_button.style.border = "3px solid white";
            eraser_button.style.border = "3px solid rgba(0, 0, 0, 0)";
        });
        
        eraser_button.addEventListener('click', ()=>
        {
            tool = "eraser";
            eraser_button.style.border = "3px solid white";
            pen_button.style.border = "3px solid rgba(0, 0, 0, 0)";
        });
        
        black_button.addEventListener('click', ()=>
        {
            pen_color = "black";
            ctx.strokeStyle = pen_color;
            black_button.style.border = "3px solid white";
            blue_button.style.border = "3px solid rgba(0, 0, 0, 0)";
        });
        
        blue_button.addEventListener('click', ()=>
        {
            pen_color = "rgb(0, 119, 255)";
            ctx.strokeStyle = pen_color;
            blue_button.style.border = "3px solid white";
            black_button.style.border = "3px solid rgba(0, 0, 0, 0)";
        });

        $('#drawingCanvas').on('pointerdown', startDrawing);
        $('#drawingCanvas').on('pointermove', drag);
        $('#drawingCanvas').on('pointerup', stop_drawing);
        $('#drawingCanvas').on('pointercancel', stop_drawing);
        $('#drawingCanvas').on('click touchend', (e)=>
        {
            e.stopPropagation();
            e.preventDefault();
        });

    </script>
</body>
</html>
